
var Controller = function() {
};

Controller.prototype.start = function() {
        var gameArea = new GameArea($('#gamearea'));
		$('#startstop').attr('value','pause');
};
Controller.prototype.gameOver = function() {
		window.alert("gameOver");
};


var GameArea = function(gameareaDiv) {
	this.width = 10;         // ten block width
	this.height = 20;
	
    this.pointSize = 20;     // size of one block in pixels
    
	this.baseSpeed = 1000; 	// Milliseconds for block to move down one row
	this.speed = 1;			// Divisor by which to divide the baseSpeed
	
	this.mess = new Mess();
	this.tetrisBlock = undefined;
	this.blockPosition = undefined;
    
    this.canvas = undefined;    
    this.clearCanvas(gameareaDiv);
};

GameArea.prototype.clearCanvas = function(aDiv) {
    if (!(this.canvas === undefined)) {
        $(this.canvas).remove();
    }
    var pixelWidth = this.pointSize * this.width;
    var pixelHeight = this.pointSize * this.height;
    this.canvas = $('<div class="gameCanvas"></div>').appendTo(aDiv).width(pixelWidth).height(pixelHeight);
}
GameArea.prototype.hasCollided = function() {
    // TODO
}
GameArea.prototype.isGameOver = function() {
		return mess.getHeight() >= this.height;
}
GameArea.prototype.loop = function() {
	// TODO is the game initialized?
	
	this.blockPosition.moveDown();
	
	if (hasCollided()) {
		this.mess.add(tetrisBlock);
		// TODO generate new block
	}
	

	if (this.isGameOver()) {
		return this;
	}
	setTimeout(this.loop(), this.baseSpeed/this.speed);
};
GameArea.prototype.moveRight = function() {
	this.blockPosition.moveRight();
};
GameArea.prototype.moveLeft = function() {
	this.blockPosition.moveLeft();
};
GameArea.prototype.moveDown = function() {
	this.blockPosition.moveDown();
};
GameArea.prototype.rotate = function() {
	// TODO rotate the displayed block
	this.tetrisBlock.rotate();
};
GameArea.prototype.deleteRow = function() {
		window.alert("Game area delete");
};


var Mess = function() {};
//Mess.prototype = new GameArea();

Mess.prototype.hasCompleteRow = function() {
};
Mess.prototype.deleteRow = function() {
	window.alert("Mess delete");
};
Mess.prototype.getPoints = function() {
};
Mess.prototype.add = function(tetrisBlock) { 
// TODO
}


var TetrisBlock = function(kind) {
    if (kind === undefined) {
        var keys = Object.keys(this.defaultBlocks);
        var randomIndex = Math.floor( Math.random() * keys.length );
        this.name = keys[randomIndex];
        this.matrix = this.defaultBlocks[keys[randomIndex]];
    } else {
        this.name = kind;
        this.matrix = this.defaultBlocks[kind];
    }   
};
TetrisBlock.prototype = new GameArea();

TetrisBlock.prototype.rotate =function() {
};
TetrisBlock.prototype.getPoints = function() {
};
TetrisBlock.prototype.defaultBlocks = {
    "sBlock": [
        [0,1,1],
    	[1,1,0]
	],
    "LBlock": [
    	[1,1,1],
		[1,0,0]
	],
    "IBlock": [
    	[1,1,1,1]
	],
    "SquareBlock" : [
        [1,1],
    	[1,1],
	],
    "MirrorLBlock": [
    	[1,1,1],
		[0,0,1]
	],
    "MirrorSBlock": [
    	[1,1,0],
		[0,1,1]
	]
    "SpecialBlock": [
    	[1,1],
		[0,1],
		[1,1],
		[1,0],
		[1,1]
	]
}

$(document).ready(function(){
    var controller = new Controller();
    $("#startstop").bind('click', function(){
        controller.start()
    });
});
